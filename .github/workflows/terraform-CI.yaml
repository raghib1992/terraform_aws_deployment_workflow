name: CI - Scan Terraform Files

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  generate-matrix:
    name: Generate Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix-json: ${{ steps.build.outputs.matrix-json }}
      matrix-count: ${{ steps.build.outputs.matrix-count }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      # - name: Get GitHub Apps Token # This enables access to Terraform modules in internal/private repos
      #   id: get_token
      #   uses: tibdex/github-app-token@v1.7.0
      #   with:
      #     private_key: ${{ secrets.ORG_REPO_READ_PRIVATE_KEY }}
      #     app_id: ${{ secrets.ORG_REPO_READ_APP_ID }}
      #   # Doc: https://github.com/marketplace/actions/github-app-token

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Generate Matrix
        id: build
        run: |
          SUBDOMAINS='${{ github.event.inputs.subdomains }}'
          TRIMMED=$(echo "$SUBDOMAINS" | tr -d '[:space:]')
          if [ -z "$TRIMMED" ]; then
            MATRIX="[]"
          else
            echo '${{ github.event.inputs.subdomains }}' > subdomains.json
            MATRIX=$(python3 scripts/build_matrix.py '${{ github.event.inputs.subdomains }}' '${{ github.event.inputs.env }}')
          fi
          echo "$MATRIX"
          COUNT=$(printf '%s' "$MATRIX" | jq 'length')
          echo "matrix-json=$MATRIX"  >> "$GITHUB_OUTPUT"
          echo "matrix-count=$COUNT" >> "$GITHUB_OUTPUT"

  terraform-scan:
    name: Scan â–º ${{ matrix.subdomain }} Subdomain
    if: ${{ needs.generate-matrix.outputs.matrix-count > 0 }}
    runs-on: ubuntu-latest
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix-json) }}
    steps:
      - name: Checkout-Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.12.2"

      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive
        working-directory: ${{ matrix.path }}

      # Use -backend=false to avoid touching remote backends/creds in CI lint stage
      - name: Terraform init (no backend)
        run: terraform init -backend=false
        working-directory: ${{ matrix.path }}

      - name: Terraform validate
        run: terraform validate -no-color
        working-directory: ${{ matrix.path }}

      # ---------- TFLint ----------
      - name: Set up TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: TFLint init (plugins)
        run: tflint --init
        working-directory: ${{ matrix.path }}

      - name: Run TFLint
        run: tflint --recursive
        working-directory: ${{ matrix.path }}
        # Add --format=compact for shorter output, or --config=.tflint.hcl if needed

      # ---------- tfsec ----------
      # Runs tfsec in Docker so you don't need to install it on the runner
      - name: Run tfsec (generate SARIF)
        working-directory: ${{ matrix.path }}
        run: |
          docker run --rm -v "$PWD":/src aquasec/tfsec:latest \
            /src --no-module-download --soft-fail=false \
            --format sarif --out tfsec.sarif

      # Optional: upload SARIF so findings show up in GitHub "Code scanning alerts"
      - name: Upload tfsec results to GitHub Code Scanning
        if: always()  # still upload even if previous steps failed
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ github.workspace }}/tfsec.sarif
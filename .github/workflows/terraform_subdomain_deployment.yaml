name: Subdomain Matrix Deploy

on:
  workflow_dispatch:
    inputs:
      subdomains:
        description: 'JSON list of subdomains (e.g. ["basket", "order-management"])'
        required: true
      env:
        description: 'Target environment (dev, qa, perf)'
        type: choice
        options:
          - dev
          - qa
          - perf
        required: true

jobs:
  generate-matrix:
    name: Generate Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix-json: ${{ steps.build.outputs.matrix-json }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Generate Matrix JSON
        id: build
        run: |
          echo "Input subdomains: ${{ github.event.inputs.subdomains }}"
          echo "Selected env: ${{ github.event.inputs.env }}"

          echo '${{ github.event.inputs.subdomains }}' > subdomains.json

          python3 <<EOF > matrix.json
import json

with open("subdomains.json") as f:
    subdomains = json.load(f)

env = "${{ github.event.inputs.env }}"

matrix = [{"subdomain": s, "env": env} for s in subdomains]
print(json.dumps(matrix))
EOF

          echo "matrix-json=$(cat matrix.json)" >> "$GITHUB_OUTPUT"
          cat matrix.json

  run-subdomain-jobs:
    name: Deploy Each Subdomain in ${{ github.event.inputs.env }}
    runs-on: ubuntu-latest
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix-json) }}
    steps:
      - name: Simulate Deployment
        run: |
          echo "Deploying subdomain: ${{ matrix.subdomain }} to environment: ${{ matrix.env }}"
          # Here you can call terraform, ansible, helm, etc.

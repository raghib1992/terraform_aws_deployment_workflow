name: Subdomain Matrix Deploy

on:
  workflow_dispatch:
    inputs:
      subdomains:
        description: 'JSON list of subdomains (e.g. ["basket", "order-management"])'
        required: true
      env:
        description: 'Target environment (dev, qa, perf)'
        type: choice
        options:
          - dev
          - qa
          - perf
        required: true

jobs:
  generate-matrix:
    name: Generate Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix-json: ${{ steps.build.outputs.matrix-json }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Generate Matrix
        id: build
        run: |
          echo '${{ github.event.inputs.subdomains }}' > subdomains.json

          MATRIX=$(python3 scripts/build_matrix.py '${{ github.event.inputs.subdomains }}' '${{ github.event.inputs.env }}')
          echo "$MATRIX"
          echo "matrix-json=$MATRIX" >> "$GITHUB_OUTPUT"

  run-subdomain-jobs:
    name: Deploy Each Subdomain in ${{ github.event.inputs.env }}
    runs-on: ubuntu-latest
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix-json) }}
    steps:
      - name: Simulate Deployment
        run: |
          echo "Deploying ${{ matrix.subdomain }} in ${{ matrix.env }}"
          echo "Using AWS Account: ${{ matrix.account_id }}"
          echo "Path: ${{ matrix.path }}"
          echo "Using AWS Account: ${{ matrix.account_name }}"
          # Here you can call terraform, ansible, helm, etc.

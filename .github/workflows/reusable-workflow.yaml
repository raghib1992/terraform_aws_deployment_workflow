name: Deployment - Resuable Deployment

on: 
  workflow_call:

jobs:
    reusable-workflow:
      name: Generate Matrix
      runs-on: ubuntu-latest
      outputs:
        matrix-json: ${{ steps.build.outputs.matrix-json }}
        matrix-count: ${{ steps.build.outputs.matrix-count }}
        account_id: ${{ steps.build.outputs.account_id }}
        account_name: ${{ steps.build.outputs.account_name }}
        bucket_name: ${{ steps.build.outputs.bucket_name }}
      steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            ref: ${{ github.ref_name }}

        - name: Setup Python
          uses: actions/setup-python@v5
          with:
            python-version: 3.x

        - name: Generate Matrix
          id: build
          run: |
            case "${{ github.event.inputs.env }}" in
              dev) 
                # BUCKET="dev-statefile-terraform" 
                # ACCOUNT_ID="254390148077"
                BUCKET="sandbox-statefile-terraform" 
                ACCOUNT_ID="800643485173"
                ACCOUNT_NAME="dev-account"
                ;;
              qa) 
                # BUCKET="qa-statefile-terraform" 
                # ACCOUNT_ID="039871571616"
                BUCKET="sandbox-statefile-terraform" 
                ACCOUNT_ID="800643485173"
                ACCOUNT_NAME="qa-account"
                ;;
              sandbox) 
                BUCKET="sandbox-statefile-terraform" 
                ACCOUNT_ID="800643485173"
                ACCOUNT_NAME="sandbox-account"
                ;;
              performance) 
                BUCKET="perf-statefile-terraform" 
                ACCOUNT_ID="677977426648"
                ACCOUNT_NAME="performance-account"
                ;;
              staging) 
                BUCKET="stg-statefile-terraform" 
                ACCOUNT_ID="649128807268"
                ACCOUNT_NAME="staging-account"
                ;;
              staging-green) 
                BUCKET="stg-green-statefile-terraform" 
                ACCOUNT_ID="606184927985"
                ACCOUNT_NAME="staging-green-account"
                ;;
              production) 
                BUCKET="poc-terraform-loc" 
                ACCOUNT_ID="271547279005"
                ACCOUNT_NAME="production-account"
                ;;
              *) echo "Unknown env"; exit 1 ;;
            esac
            
            SUBDOMAINS='${{ github.event.inputs.subdomains }}'
            TRIMMED=$(echo "$SUBDOMAINS" | tr -d '[:space:]')
            if [ -z "$TRIMMED" ]; then
              MATRIX="[]"
            else
              echo '${{ github.event.inputs.subdomains }}' > subdomains.json
              MATRIX=$(python3 scripts/build_matrix.py '${{ github.event.inputs.subdomains }}' '${{ github.event.inputs.env }}')
            fi
            echo "$MATRIX"
            COUNT=$(printf '%s' "$MATRIX" | jq 'length')
            echo "matrix-json=$MATRIX"  >> "$GITHUB_OUTPUT"
            echo "matrix-count=$COUNT" >> "$GITHUB_OUTPUT"
            echo "bucket_name=$BUCKET" >> "$GITHUB_OUTPUT"
            echo "account_id=$ACCOUNT_ID" >> "$GITHUB_OUTPUT"
            echo "account_name=$ACCOUNT_NAME" >> "$GITHUB_OUTPUT"